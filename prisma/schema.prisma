generator client {
  provider             = "prisma-client-py"
  //TODO: why is this breaking my ORM
  // https://github.com/prisma/prisma/discussions/25127
  // output               = "../generated/prisma"
  interface            = "asyncio"
  recursive_type_depth = "5"
}

datasource db {
  provider = "postgresql"
  // CONNECTION LIMIT CONFIGURATION:
  // Add ?connection_limit=N to your DATABASE_URL to limit the number of concurrent connections.
  // Example: postgresql://user:pass@host:port/dbname?connection_limit=100
  // This value should match DATA_BASE_CONCURRENCY_LIMIT in options/decorator.py
  // The connection_limit parameter in the URL string limits Prisma's internal connection pool.
  url      = env("DATABASE_URL")
}

model Options {
  id                Int              @id @default(autoincrement())
  ticker            String           @unique
  underlying_ticker String
  contract_type     String
  expiration_date   DateTime         @db.Timestamptz(6)
  strike_price      Float
  snapshots         OptionSnapshot[]

  @@index([underlying_ticker, expiration_date])
  @@index([strike_price])
  @@map("options")
}

model OptionSnapshot {
  id            Int      @default(autoincrement())
  ticker        String
  volume        Float?
  day_change    Float?
  day_close     Float?
  day_open      Float?
  implied_vol   Float?
  last_price    Float?
  last_updated  DateTime @db.Timestamptz(6)
  last_crawled  DateTime @db.Timestamptz(6)
  open_interest Int?
  greeks        Json?
  option        Options  @relation(fields: [ticker], references: [ticker])

  @@id([ticker, last_updated])
  @@unique([ticker, last_updated])
  @@index([last_updated(sort: Desc)])
  @@map("option_snapshots")
}
